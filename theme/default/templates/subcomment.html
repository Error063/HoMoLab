<!DOCTYPE html>
<html lang="zh">
<head>
    <link rel="stylesheet" type="text/css" href="/resources?css=hoyolab">
    <link rel="stylesheet" href="{{ url_for('static',filename='css/styles.css') }}">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
        <script>
            function upVoteReply(reply_id, post_id, isCancel, i) {
                window.parent.pywebview.api.upVoteReply(reply_id, post_id, isCancel).then(function (status) {
                    if (status['status'] === 'ok'){
                        let btn = document.getElementsByClassName("voteReplyBtn")[i]
                        btn.textContent = isCancel?'点赞':'取消点赞'
                        btn.setAttribute('onclick', `upVoteReply('${reply_id}','${post_id}', ${(!isCancel).toString()})`)
                        let voteNum = document.getElementsByClassName('voteReplyNum')[i]
                        voteNum.textContent = isCancel?(Number(voteNum.textContent) - 1).toString():(Number(voteNum.textContent) + 1).toString()
                    }
                    console.info(status['status'])
                })
            }
        </script>
    <meta charset="UTF-8">
</head>
<body>
<div class="replies">
    <div class="pageControl">
        <button class="pageButton" onclick="window.location.href = '/comments?id={{ replies.post_id }}&gid={{ replies.gid }}'">返回</button>
    </div>
    <div class="reply mainReply">
        <div class="user commentUser">
            <img class="avatar" src="{{ rootReply.comment['avatar'] }}"/>
            <div class="userinfo">
                <div class="nickname">{{ rootReply.comment['username'] }}</div>
                <div class="describe">{{ rootReply.comment['describe'] }}</div>
            </div>
        </div>
        <div class="comment" id="rootComment"></div>
    <script>
        let quill_rootComment = new Quill('#rootComment', {theme: 'bubble'});
        quill_rootComment.enable(false);
        quill_rootComment.setContents({{ rootReply.comment['content'] | safe }})
    </script>
        <span>点赞数：</span>
        <span class="voteReplyNum">{{ rootReply.comment['like_num'] }}</span>
        {% if account.isLogin %}
            <button class="voteReplyBtn pageButton" onclick="upVoteReply('{{ rootReply.comment['reply_id'] }}', '{{ rootReply.comment['post_id'] }}', {{ 'true' if rootReply.comment['upvoted'] else 'false' }})">{{ '取消点赞' if rootReply.comment['upvoted'] else '点赞' }}</button>
        {% endif %}
    </div>
{% for i in range(replies.comments | length) %}
    <div class="reply">
        <div class="user commentUser">
            <img class="avatar" src="{{ replies.comments[i]['avatar'] }}"/>
            <div class="userinfo">
                <div class="nickname">{{ replies.comments[i]['username'] }}</div>
                <div class="describe">{{ replies.comments[i]['describe'] }}</div>
            </div>
        </div>
        <div class="comment" id="comment-{{ i }}"></div>
    <script>
        let quill_{{ i }} = new Quill('#comment-{{ i }}', {theme: 'bubble'});
        quill_{{ i }}.enable(false);
        quill_{{ i }}.setContents({{ replies.comments[i]['content'] | safe }})
    </script>
        <span>点赞数：</span>
        <span class="voteReplyNum">{{ replies.comments[i]['like_num'] }}</span>
        {% if account.isLogin %}
            <button class="voteReplyBtn pageButton" onclick="upVoteReply('{{ replies.comments[i]['reply_id'] }}', '{{ replies.comments[i]['post_id'] }}', {{ 'true' if replies.comments[i]['upvoted'] else 'false' }}, {{ i + 1 }})">{{ '取消点赞' if replies.comments[i]['upvoted'] else '点赞' }}</button>
        {% endif %}
    </div>
{% endfor %}
    <div class="pageControl">
{% if replies.isLastFlag and replies.page == 1 %}
    <span>没有更多了</span>
{% else %}
        {% if prev_id != '-1' %}
            <a href="/comments?id={{ replies.post_id }}&gid={{ replies.gid }}&reply_id={{ reply_id }}&floor_id={{ floor_id }}&last_id={{ prev_id }}">
                <button class="pageButton">上一页</button>
            </a>
        {% endif %}
        {% if not replies.isLastFlag %}
            <a href="/comments?id={{ replies.post_id }}&gid={{ replies.gid }}&reply_id={{ reply_id }}&floor_id={{ floor_id }}&last_id={{ replies.last_id }}">
                <button class="pageButton">下一页</button>
            </a>
        {% endif %}
{% endif %}
    </div>
</div>
</body>